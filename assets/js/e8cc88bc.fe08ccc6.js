"use strict";(self.webpackChunkcourse=self.webpackChunkcourse||[]).push([[752],{3905:function(e,t,n){n.d(t,{Zo:function(){return d},kt:function(){return m}});var r=n(7294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,r,o=function(e,t){if(null==e)return{};var n,r,o={},a=Object.keys(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var s=r.createContext({}),p=function(e){var t=r.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},d=function(e){var t=p(e.components);return r.createElement(s.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},c=r.forwardRef((function(e,t){var n=e.components,o=e.mdxType,a=e.originalType,s=e.parentName,d=l(e,["components","mdxType","originalType","parentName"]),c=p(n),m=o,k=c["".concat(s,".").concat(m)]||c[m]||u[m]||a;return n?r.createElement(k,i(i({ref:t},d),{},{components:n})):r.createElement(k,i({ref:t},d))}));function m(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var a=n.length,i=new Array(a);i[0]=c;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:o,i[1]=l;for(var p=2;p<a;p++)i[p]=n[p];return r.createElement.apply(null,i)}return r.createElement.apply(null,n)}c.displayName="MDXCreateElement"},7391:function(e,t,n){n.r(t),n.d(t,{frontMatter:function(){return l},contentTitle:function(){return s},metadata:function(){return p},toc:function(){return d},default:function(){return c}});var r=n(7462),o=n(3366),a=(n(7294),n(3905)),i=["components"],l={sidebar_position:4},s="Events & Errors",p={unversionedId:"scilla/events_errors",id:"scilla/events_errors",isDocsHomePage:!1,title:"Events & Errors",description:"In some of the eariler topics, we already saw some events outputs. In this section, we are going to introduce Scilla events and how to throw errors exception in greater details.",source:"@site/docs/scilla/events_errors.md",sourceDirName:"scilla",slug:"/scilla/events_errors",permalink:"/zilliqa-tldr-dapp-course/docs/scilla/events_errors",editUrl:"https://github.com/teye/zilliqa-tldr-dapp-course/docs/scilla/events_errors.md",tags:[],version:"current",sidebarPosition:4,frontMatter:{sidebar_position:4},sidebar:"tutorialSidebar",previous:{title:"Maps",permalink:"/zilliqa-tldr-dapp-course/docs/scilla/maps"},next:{title:"Custom ADT(s)",permalink:"/zilliqa-tldr-dapp-course/docs/scilla/custom_adts"}},d=[{value:"Events",id:"events",children:[{value:"Syntax",id:"syntax",children:[],level:4},{value:"Example",id:"example",children:[],level:4}],level:2},{value:"Errors",id:"errors",children:[{value:"Syntax",id:"syntax-1",children:[],level:4}],level:2},{value:"Exercises",id:"exercises",children:[],level:2}],u={toc:d};function c(e){var t=e.components,l=(0,o.Z)(e,i);return(0,a.kt)("wrapper",(0,r.Z)({},u,l,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"events--errors"},"Events & Errors"),(0,a.kt)("p",null,"In some of the eariler topics, we already saw some events outputs. In this section, we are going to introduce Scilla events and how to throw errors exception in greater details."),(0,a.kt)("h2",{id:"events"},"Events"),(0,a.kt)("p",null,"A Scilla event is an output of a function call. Normally, we used it to output mutable field values after updating them. Scilla events can be read from the blockchain transaction receipt."),(0,a.kt)("h4",{id:"syntax"},"Syntax"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},'  transition transitionName()\n    e = {_eventname: "EventName"; field: "your_msg"}\n    event e\n  end\n')),(0,a.kt)("p",null,"To output events, we first declare an ",(0,a.kt)("inlineCode",{parentName:"p"},"e")," object and use the ",(0,a.kt)("inlineCode",{parentName:"p"},"_eventname")," keyword. Next, we need to give this event a name and also add the contents that will be output. Finally, we emit the event by calling ",(0,a.kt)("inlineCode",{parentName:"p"},"event e"),"."),(0,a.kt)("h4",{id:"example"},"Example"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},'  transition demoA()\n   e = {_eventname: "demoA"; msg: "hello, I am a Scilla event"};\n   event e\n  end\n')),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},'  transition demoB(input: Uint128)\n    e = {_eventname: "demoB"; num: input}\n    event e  \n  end\n')),(0,a.kt)("p",null,"Above are some examples how events can be used. An event can output any types as long as the types are valid. For instance in ",(0,a.kt)("inlineCode",{parentName:"p"},"demoB"),", we can output a ",(0,a.kt)("inlineCode",{parentName:"p"},"Uint128")," supplied by the user."),(0,a.kt)("p",null,"To view the events output, we can view the transaction state on blockchain explorer such as ",(0,a.kt)("a",{parentName:"p",href:"https://devex.zilliqa.com"},(0,a.kt)("strong",{parentName:"a"},"Devex Zilliqa"))," and ",(0,a.kt)("a",{parentName:"p",href:"https://viewblock.io/zilliqa"},(0,a.kt)("strong",{parentName:"a"},"ViewBlock")),"."),(0,a.kt)("p",null,"An example of invoking the transition ",(0,a.kt)("inlineCode",{parentName:"p"},"demoB"),' looks like this on Devex Zilliqa under "Event Logs" section:'),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"Devex Zilliqa Emit Event",src:n(3343).Z})),(0,a.kt)("h2",{id:"errors"},"Errors"),(0,a.kt)("p",null,"In Scilla, learning how to throw errors is also essential to contract writing. Frequently, we would have some checks and depending on the result of the checks, we would proceed to do something or throw an error to halt the contract execution."),(0,a.kt)("h4",{id:"syntax-1"},"Syntax"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},'scilla_version 0\n\nlibrary DemoError\n\n(* Error events *)\ntype Error =\n| CodeNotOwner\n| CodeNotFound\n| CodeAlreadyExists\n\n(* Library function that maps Error to a error code *)\nlet make_error =\n  fun (result : Error) =>\n    let result_code =\n      match result with\n      | CodeNotOwner       => Int32 -1\n      | CodeNotFound       => Int32 -2\n      | CodeAlreadyExists  => Int32 -3\n      end\n    in\n    { _exception : "Error"; code : result_code }\n\n\ncontract DemoError()\n\nfield products : Map Uint128 String : Emp Uint128 String\n\n(* Emit Errors *)\nprocedure ThrowError(err : Error)\n  e = make_error err;\n  throw e\nend\n\ntransition AddItem(id: Uint128, name: String)\n  product_name <- products[id];\n  match product_name\n  | Some existing_product =>\n    (* item already exists; throw error *)\n    err = CodeAlreadyExists;\n    ThrowError err\n  | None =>\n    (* no existing item; proceed to add to map *)\n    products[id] := name\n  end\nend\n')),(0,a.kt)("p",null,"In the above transition ",(0,a.kt)("inlineCode",{parentName:"p"},"AddItem()"),", it checks if the item already eixsts for the specific id, if so we throw a ",(0,a.kt)("inlineCode",{parentName:"p"},"CodeAlreadyExists")," error. Otherwise, we add the item into the map."),(0,a.kt)("p",null,"Let's take a look at how the error is declared and thrown."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},'(* Error events *)\ntype Error =\n| CodeNotOwner\n| CodeNotFound\n| CodeAlreadyExists\n\n(* Library function that maps Error to a error code *)\nlet make_error =\n  fun (result : Error) =>\n    let result_code =\n      match result with\n      | CodeNotOwner       => Int32 -1\n      | CodeNotFound       => Int32 -2\n      | CodeAlreadyExists  => Int32 -3\n      end\n    in\n    { _exception : "Error"; code : result_code }\n')),(0,a.kt)("p",null,"First, we declare a ",(0,a.kt)("strong",{parentName:"p"},"Custom ADT")," (Custom Abstract Data Type) which is something like a custom object that defines an ",(0,a.kt)("inlineCode",{parentName:"p"},"Error")," object. Our custom ",(0,a.kt)("inlineCode",{parentName:"p"},"Error")," object has 3 attributes or definitions that determines what error type we can throw. The error type namings can be any names and has no limits to the number of errors that can be defined."),(0,a.kt)("p",null,"Next, we defined a library function ",(0,a.kt)("inlineCode",{parentName:"p"},"make_error")," which maps our ",(0,a.kt)("inlineCode",{parentName:"p"},"Error")," types into a ",(0,a.kt)("inlineCode",{parentName:"p"},"Int32")," number and also outputs the mapping into the form ",(0,a.kt)("inlineCode",{parentName:"p"},'{_exception : "Error"; code : result_code }'),"."),(0,a.kt)("p",null,"We can think of this library function like a Javascript JSON, e.g."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"  {\n    CodeNotOwner : -1,\n    CodeNotFound : -2,\n    CodeAlreadyExists : -3,\n  }\n")),(0,a.kt)("p",null,"This mapping allow us to compare errors easily and also makes it easier to read in transaction outputs. In the example, we have used a negative number. There isn't a strict rule to use a negative number for error codes, positive numbers are also allowed as well."),(0,a.kt)("p",null,"Next, we have a procedure ",(0,a.kt)("inlineCode",{parentName:"p"},"ThrowError(err : Error)")," that takes in our error code, calls our ",(0,a.kt)("inlineCode",{parentName:"p"},"make_error")," library and throws an exception via the keyword ",(0,a.kt)("inlineCode",{parentName:"p"},"throw"),"."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"procedure ThrowError(err : Error)\n  e = make_error err;\n  throw e\nend\n")),(0,a.kt)("p",null,"Finally, we can invoke this procedure from a transition or another procedure calls by declaring the error type ",(0,a.kt)("inlineCode",{parentName:"p"},"(err = <OurSelfDefinedErrorType>)")," and calling the ",(0,a.kt)("inlineCode",{parentName:"p"},"ThrowError err"),"."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"transition TestError()\n  err = CodeNotFound;\n  ThrowError err\nend\n")),(0,a.kt)("p",null,"To view the errors output, we can view the transaction state on blockchain explorer such as ",(0,a.kt)("a",{parentName:"p",href:"https://devex.zilliqa.com"},(0,a.kt)("strong",{parentName:"a"},"Devex Zilliqa"))," and ",(0,a.kt)("a",{parentName:"p",href:"https://viewblock.io/zilliqa"},(0,a.kt)("strong",{parentName:"a"},"ViewBlock")),"."),(0,a.kt)("p",null,"An example of invoking the transition ",(0,a.kt)("inlineCode",{parentName:"p"},"TesetError"),' looks like this on Devex Zilliqa under "Exceptions" section:'),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"Devex Zilliqa Throw Error",src:n(8765).Z})),(0,a.kt)("h2",{id:"exercises"},"Exercises"),(0,a.kt)("p",null,"The following are some exercises to help you be familiar with events and procedures."),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Instructions")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Download this ",(0,a.kt)("a",{parentName:"li",href:"https://github.com/teye/zilliqa-tldr-dapp-course/blob/main/exercises/chapter1/ch01_cryptomon_events_errors.scilla"},(0,a.kt)("strong",{parentName:"a"},"CryptoMon Contract"))," to get started.")),(0,a.kt)("br",null),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Task 1: Events")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Add checks to ",(0,a.kt)("inlineCode",{parentName:"li"},"AddCryptoMon()")," such that we only add the new ",(0,a.kt)("inlineCode",{parentName:"li"},"token_id")," if the ",(0,a.kt)("inlineCode",{parentName:"li"},"token_id")," is a new entry. ",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"After we have added the new ",(0,a.kt)("inlineCode",{parentName:"li"},"token_id")," into the map, emit an event ",(0,a.kt)("inlineCode",{parentName:"li"},'e = {_eventname: "AddCryptoMon"; token_id: token_id; owner: address}')),(0,a.kt)("li",{parentName:"ul"},"If the ",(0,a.kt)("inlineCode",{parentName:"li"},"token_id")," already exists, we do nothing for now."))),(0,a.kt)("li",{parentName:"ul"},"Add checks to ",(0,a.kt)("inlineCode",{parentName:"li"},"DeleteCryptoMon()")," such that we only delete the ",(0,a.kt)("inlineCode",{parentName:"li"},"token_id")," if the ",(0,a.kt)("inlineCode",{parentName:"li"},"token_id")," exists. ",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"After we have deleted the ",(0,a.kt)("inlineCode",{parentName:"li"},"token_id")," from the map, emit an event ",(0,a.kt)("inlineCode",{parentName:"li"},'e = {_eventname: "DeleteCryptoMon; token_id: token_id"}')),(0,a.kt)("li",{parentName:"ul"},"If the ",(0,a.kt)("inlineCode",{parentName:"li"},"token_id")," does not exist, we do nothing for now.")))),(0,a.kt)("br",null),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Task 2: Errors")),(0,a.kt)("p",null,"Continuing from the previous tasks, recall that there are some portions of the checks for ",(0,a.kt)("inlineCode",{parentName:"p"},"AddCryptoMon")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"DeleteCryptoMon")," which we do nothing? Now, we are going to throw an error for these checks."),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Create a ",(0,a.kt)("inlineCode",{parentName:"li"},"type Error")," and defined two types: (1) ",(0,a.kt)("inlineCode",{parentName:"li"},"CodeCryptoMonNotExists")," and (2) ",(0,a.kt)("inlineCode",{parentName:"li"},"CodeCryptoMonAlreadyExists"),"."),(0,a.kt)("li",{parentName:"ul"},"Create the ",(0,a.kt)("inlineCode",{parentName:"li"},"make_error")," library function and assigned the above codes to a ",(0,a.kt)("inlineCode",{parentName:"li"},"Int32")," number of your choice."),(0,a.kt)("li",{parentName:"ul"},"Create a ",(0,a.kt)("inlineCode",{parentName:"li"},"ThrowError")," procedure that takes in the ",(0,a.kt)("inlineCode",{parentName:"li"},"Error")," type and calls ",(0,a.kt)("inlineCode",{parentName:"li"},"make_error")," and throw the error exception."),(0,a.kt)("li",{parentName:"ul"},"Edit the transition ",(0,a.kt)("inlineCode",{parentName:"li"},"AddCryptoMon")," to throw ",(0,a.kt)("inlineCode",{parentName:"li"},"CodeCryptoMonAlreadyExists")," if we try to add a ",(0,a.kt)("inlineCode",{parentName:"li"},"token_id")," that already existed in the map."),(0,a.kt)("li",{parentName:"ul"},"Edit the transition ",(0,a.kt)("inlineCode",{parentName:"li"},"DeleteCryptoMon")," to throw ",(0,a.kt)("inlineCode",{parentName:"li"},"CodeCryptoMonNotExists")," if we try to delete a ",(0,a.kt)("inlineCode",{parentName:"li"},"token_id")," that is not present in the map.")),(0,a.kt)("br",null),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Task 3: Testing")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Deploy the contract on  ",(0,a.kt)("a",{parentName:"li",href:"https://ide.zilliqa.com/"},(0,a.kt)("strong",{parentName:"a"},"Neo-Savant IDE"))," on ",(0,a.kt)("strong",{parentName:"li"},"Simulated Env"),"."),(0,a.kt)("li",{parentName:"ul"},"Execute ",(0,a.kt)("inlineCode",{parentName:"li"},"AddCryptoMon(1, <your_wallet_address>)"),".",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"Observe the transaction output."),(0,a.kt)("li",{parentName:"ul"},"The event ",(0,a.kt)("inlineCode",{parentName:"li"},"AddCryptoMon, token_id: 1, owner: <wallet_address>")," shoud be emitted."))),(0,a.kt)("li",{parentName:"ul"},"Execute ",(0,a.kt)("inlineCode",{parentName:"li"},"AddCryptoMon(1, <your_wallet_address>)")," again.",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"Observe the transaction output."),(0,a.kt)("li",{parentName:"ul"},"The error ",(0,a.kt)("inlineCode",{parentName:"li"},"CodeCryptoMonAlreadyExists")," should be thrown."))),(0,a.kt)("li",{parentName:"ul"},"Execute ",(0,a.kt)("inlineCode",{parentName:"li"},"DeleteCryptoMon(1)"),".",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"Observe the transaction output."),(0,a.kt)("li",{parentName:"ul"},"The event ",(0,a.kt)("inlineCode",{parentName:"li"},"DeleteCryptoMon, token_id: 1")," shoud be emitted."))),(0,a.kt)("li",{parentName:"ul"},"Execute ",(0,a.kt)("inlineCode",{parentName:"li"},"DeleteCryptoMon(1)")," again.",(0,a.kt)("ul",{parentName:"li"},(0,a.kt)("li",{parentName:"ul"},"Observe the transaction output."),(0,a.kt)("li",{parentName:"ul"},"The error ",(0,a.kt)("inlineCode",{parentName:"li"},"CodeCryptoMonNotExists")," should be thrown.")))))}c.isMDXComponent=!0},8765:function(e,t,n){t.Z=n.p+"assets/images/errors-9b6db59045b486432b22a5c2d48fabae.png"},3343:function(e,t,n){t.Z=n.p+"assets/images/events-cdbc7b0627c67069a0b2b93e4ffdad72.png"}}]);